---
title: "Track_simulation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Track_simulation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
require(foieGras)
require(ggplot2)
require(patchwork)
```
`foieGras` provides 2 track simulation functions for simulating random tracks from a few different movement process models, `sim()`, and for simulating random tracks from fitted SSM models, `simfit()`. 

The `sim` function is useful for any situation where simulated random tracks are required, such as understanding how observed animal tracks deviate from the expectations of the `rw`, `crw` or `mp` movement process models. Tracks can be simulated with regular or random time intervals between locations, and with Argos Least-Squares- or Kalman filter-based location errors. Multiple states with stochastic switching can be implemented for the `rw` and `crw` models.

### Simulate tracks from each of the 3 process models:
```{r sim}
set.seed(pi)
sim.rw <- sim(N = 200, model = "rw")
sim.crw <- sim(N = 200, model = "crw", D = 0.5)
sim.mp <- sim(N = 200, model = "mp", sigma_g = 0.3)
```

## Plot simulated tracks:
```{r plot.sim, fig.width=7, fig.height=6}
(plot(sim.rw, type=2) + labs(title="'rw'") | plot(sim.crw, type=2) + labs(title="'crw'")) / 
  (plot(sim.mp, type = 2) + labs(title="'mp'") | plot(sim.mp, type = 1)) + 
  plot_layout(guides = 'collect') & 
  theme(legend.position = 'bottom')
```

The `simfit` function is rather different, taking a `foieGras` SSM fit object (class `ssm_df`) and simulating replicate tracks by using the movement parameter estimates from the fitted model. Currently, tracks can be simulated from `rw` and `crw` SSM model fits. Tracks can be simulated from either the observation times (`what = "fitted"`) or the prediction times (`what = "predicted"`) and, thus, are constrained to have the same number of locations. The simulated tracks are otherwise unconstrained and should *not* be considered as resampled tracks suitable for exploring uncertainty in the SSM-estimated track. They are useful for habitat usage modelling, to represent habitat that is potentially available to a collection of tracked individuals (e.g., Hindell et al. 2020). 

## Simulate tracks from an SSM fit and plot:
```{r simfit 1, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
fit <- fit_ssm(sese2, model="crw", time.step=24, control=ssm_control(verbose=0))
st <- simfit(fit[2,], what="predicted", reps=5)

plot(st, zoom=TRUE)
```

In this case, 3 of the 5 replicate tracks (purple) cross onto land in southeast Asia. We can further constrain the tracks to avoid land by adding a potential function (Brillinger et al. 2012) to the simulation that down-weights movements that cross onto land. 

## Simulate tracks with a potential function to help avoid land:
```{r simfit potential fn, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
grad <- readRDS(system.file("extdata/grad.RDS", package = "foieGras"))

st.pf <- simfit(fit[2, ], what = "predicted", reps=5, grad=grad, beta=c(-300,-300))

plot(st.pf, zoom=TRUE)
```

Here, we use built in gradient rasters based on distance from ocean and strongly negative beta parameters (for the x and y directions, respectively) to down-weight movements onto land. Custom gradients can be supplied, e.g., for finer-scale tracks or for other kinds of barriers to movement. The strength of the potential function can be varied by altering the magnitude of the beta parameters, although extremely strong values can yield implausible artefacts in the resulting tracks. Note that with `beta = c(-300,-300)`, the tracks do not all entirely avoid crossing land. One track (at upper right, crosses part of Sulawesi); narrow penninsulas pose a particular difficulty for this method.

## Simulate central place poraging tracks
The SSM-estimated track in the above example implies a central place foraging strategy, where the southern elephant seal departs from its breeding colony on Iles Kerguelen for an extended period of time and eventually returns. The simulated tracks do not reflect this strategy because the `crw` SSM fitted to the data does not have long-term memory or any other mechanism that could mimic the return portion of the foraging trip. We can, however, constrain the simulated tracks to return to their origin by applying a simple Brownian Bridge using the `cpf` argument:
```{r simfit 4, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
st.cpf <- simfit(fit[2, ], what = "predicted", reps=5, cpf = TRUE)

plot(st.cpf, zoom=TRUE)
```

Now the simulated tracks better approximate the SSM-estimated track in terms of total space used. The `cpf` argument can be used in conjunction with the potential function, however, care should be taken as their implementations are independent with the potential function applied first. This means tracks that successfully avoid crossing land due to the potential function are not guaranteed to remain so after applying the `cpf` argument.

## Simulated track filtering
When simulating a large number of replicate tracks using `simfit`, some portion of the simulations may reflect unrealistic movement patterns due to the relatively unconstrained nature of the simulation. A simple approach for identifying and removing unrealistic simulated tracks is to use a similarity filter (e.g., Hazen et al. 2017). The `sim_filter` function can calculate two related similarity functions



## References
Brillinger DR, Preisler HK, Ager AA, Kie J (2012) The use of potential functions in modelling animal movement. In: Guttorp P., Brillinger D. (eds) Selected Works of David Brillinger. Selected Works in Probability and Statistics. Springer, New York. pp. 385-409. https://link.springer.com/chapter/10.1007/978-1-4614-1344-8_22

Hazen et al. (2017) WhaleWatch: a dynamic management tool for predicting blue whale density in the California Current J. Appl. Ecol. 54: 1415-1428 https://besjournals.onlinelibrary.wiley.com/doi/10.1111/1365-2664.12820

Hindell MA, Reisinger RR, Ropert-Coudert Y, et al. (2020) Tracking of marine predators to protect Southern Ocean ecosystems. Nature. 580:87â€“92. https://www.nature.com/articles/s41586-020-2126-y