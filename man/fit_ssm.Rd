% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fit_ssm.R
\name{fit_ssm}
\alias{fit_ssm}
\title{Fit Continuous-Time State-Space Models to filter Argos satellite
geolocation data}
\usage{
fit_ssm(
  x,
  vmax = 5,
  ang = c(15, 25),
  distlim = c(2500, 5000),
  spdf = TRUE,
  min.dt = 60,
  pf = FALSE,
  model = "crw",
  time.step = NA,
  emf = NULL,
  map = NULL,
  parameters = NULL,
  fit.to.subset = TRUE,
  control = ssm_control(),
  inner.control = NULL,
  ...
)
}
\arguments{
\item{x}{a \code{data.frame}, \code{tibble} or \code{sf-tibble} of observations, depending
on the tracking data type. See more in the Details section, below, and the
Overview vignette \code{vignette("Overview", package = "aniMotum")}.}

\item{vmax}{max travel rate (m/s) to identify implausible locations}

\item{ang}{angles (deg) of implausible location "spikes"}

\item{distlim}{lengths (m) of implausible location "spikes"}

\item{spdf}{(logical) turn pre-filtering on (default; TRUE) or off}

\item{min.dt}{minimum allowable time difference between observations;
\code{dt <= min.dt} will be ignored by the SSM}

\item{pf}{just pre-filter the data, do not fit the SSM (default is FALSE)}

\item{model}{fit a simple random walk (\code{rw}), correlated random walk
(\code{crw}), or a time-varying move persistence model (\code{mp}), all as
continuous-time process models}

\item{time.step}{options: 1) the regular time interval, in hours, to predict to;
2) a vector of prediction times, possibly not regular, must be
specified as a data.frame with id and POSIXt dates; 3) NA - turns off
prediction and locations are only estimated at observation times.}

\item{emf}{optionally supplied data.frame of error multiplication factors for
Argos location quality classes. Default behaviour is to use the factors
supplied by \link{emf}}

\item{map}{a named list of parameters as factors that are to be fixed during
estimation, e.g., \code{list(psi = factor(NA))}}

\item{parameters}{a list of initial values for all model parameters and
unobserved states, default is to let sfilter specify these. Only play with
this if you know what you are doing}

\item{fit.to.subset}{fit the SSM to the data subset determined by
\link{prefilter} (default is TRUE)}

\item{control}{list of control settings for the outer optimizer
(see \link{ssm_control} for details)}

\item{inner.control}{list of control settings for the inner optimizer
(see \link[TMB:MakeADFun]{TMB::MakeADFun} for additional details)}

\item{...}{variable name arguments passed to format_data, see
\link{format_data} for details}
}
\value{
a list with components
\itemize{
\item \code{call} the matched call
\item \code{predicted} an sf tbl of predicted location states
\item \code{fitted} an sf tbl of fitted locations
\item \code{par} model parameter summary
\item \code{data} an augmented sf tbl of the formatted input data
\item \code{inits} a list of initial values
\item \code{pm} the process model fit, either "rw" or "crw"
\item \code{ts} time time.step in h used
\item \code{opt} the object returned by the optimizer
\item \code{tmb} the TMB object
\item \code{rep} TMB sdreport
\item \code{aic} the calculated Akaike Information Criterion
\item \code{time} the processing time for sfilter
}
}
\description{
fits: i) a simple random walk (\code{rw}) ii) a correlated random walk
(\code{crw} - a random walk on velocity), or iii) a time-varying move persistence
model (\code{mp}), all in continuous-time, to filter Argos LS, and/or KF/KS
location data, processed light-level geolocation data (GLS), and/or GPS data.
Location data of different types can combined in a single data frame
(see details). Predicts locations at user-specified time intervals
(regular or irregular).
}
\details{
\code{x} is a \code{data.frame}, \code{tibble}, or \code{sf-tibble} with 5, 7 or 8
columns (the default format), depending on the tracking data type. Argos
Least-Squares and GPS data should have 5 columns in the following order:
\strong{\code{id}, \code{date}, \code{lc}, \code{lon}, \code{lat}}. Where \code{date} can be a POSIX object or text
string in YYYY-MM-DD HH:MM:SS format. If a text string is supplied then the
time zone is assumed to be \code{UTC}. lc (location class) can include the
following values: 3, 2, 1, 0, A, B, Z, G, or GL. The latter two are for GPS
and GLS locations, respectively. Class Z values are assumed to have the same
error variances as class B. By default, class \code{G} (GPS) locations are assumed
to have error variances 10x smaller than Argos class 3 variances, but unlike
Argos error variances the GPS variances are the same for longitude and latitude.

The \link{format_data} function can be used as a data pre-processing
step or called automatically within \code{fit_ssm} to restructure data that is
not in one of the above default formats. The minimum essential variables:
\strong{\code{id}, \code{date}, \code{lc}, \code{lon}, \code{lat}} must exist in the input data but they can
have different names and exist in a different column order. See
\link{format_data} for details.

See \link{emf} for details on how to modify these assumptions.

Argos Kalman Filter (or Kalman Smoother) data should have 8 columns,
including the above 5 plus \strong{\code{smaj}, \code{smin}, \code{eor}} that contain Argos error
ellipse variables (in m for \code{smaj}, \code{smin} and deg for \code{eor}).

Light-level geolocation (GLS) locations can be modelled provided each
longitude and latitude has a corresponding standard error. These data should
have 7 columns, including the above 5 plus \code{lonerr}, \code{laterr} (in degrees).
In this case, all lc values should be set to \code{GL}.

Multiple location data types can be combined in a single data frame
(see the Overview vignette for examples).

When data are provided as an \code{sf-tibble}, the user-specified projection is
respected, although projected units are always transformed to km to improve
SSM convergence efficiency. Otherwise, longlat data are re-projected
internally to a global Mercator grid and provided as the default output.
A simple \code{tibble}, without a geom, of \verb{lon,lat} and \verb{x,y} location estimates
can be obtained by using \link{grab} with the argument \code{as_sf = FALSE}.
}
\examples{
## fit crw model to Argos LS data
fit <- fit_ssm(ellie, vmax = 4, model = "crw", time.step = 24, 
control = ssm_control(verbose = 0)) 

## time series plots of fitted values and observations
plot(fit, what = "fitted", type = 1, ask = FALSE)

## 2-D tracks plots of predicted values and observations
plot(fit, what = "predicted", type = 2, ask = FALSE)


}
\references{
Jonsen ID, Patterson TA, Costa DP, et al. (2020) A continuous-time state-space
model for rapid quality-control of Argos locations from animal-borne tags.
Movement Ecology 8:31

Jonsen ID, McMahon CR, Patterson TA, et al. (2019) Movement responses to
environment: fast inference of variation among southern elephant seals with
a mixed effects model. Ecology. 100(1):e02566
}
